<html>

	<head>
		<title>Aeriform</title>
	</head>

	<body
        style="
            background-color: black;
            margin: 0;
            height: 100%;
            width: 100%;
            justify-content: center;
            align-items: center;
        ">

        <link rel="stylesheet" href="style.css">

        <script src="ThreeMin.js"></script>
        <script src="3js/loaders/GLTFLoader.js"></script>
        <script src="3js/loaders/FontLoader.js"></script>
        <script src="3js/controls/FirstPersonControls.js"></script>
        <script src="3js/geometries/TextGeometry.js"></script>
        
        <script> 
            const sleep = sec => new Promise(r => setTimeout(r, sec*1_000))

            const camera_placings = [
                [1.0066544111402496, -0.08902988937746323, -10.828732975955903, 0.017285800040492433, -0.2468450125445477, 0.004106891538857817],
                [0.9001129996291835, -0.44667495571716836, -12.726222640853901, 0.10841063274123983, -0.17786858959131863, 0.01925445144624984],
                [1.827566140670746, -0.40457597671216744, -13.384445504435558, 0.04315208464779503, -0.0878911038220728, 0.003790137950046403],
                [2.0774814900953604, -0.34813245469953147, -15.206418047956898, 0.07227542077054726, -0.2484735210153035, 0.017803440341616527],
                [1.9624814900953604, -0.34813245469953147, -15.466418047956898, 0.07227542077054726, -0.2484735210153035, 0.017803440341616527],
            ]
            function place_camera(camera_placing) {
                camera.position.x = camera_placing[0]
                camera.position.y = camera_placing[1] 
                camera.position.z = camera_placing[2] 
                camera.rotation.x = camera_placing[3] 
                camera.rotation.y = camera_placing[4] 
                camera.rotation.z = camera_placing[5] 
            }
            function displace_camera(camera_placing) {
                camera.position.x += camera_placing[0]
                camera.position.y += camera_placing[1] 
                camera.position.z += camera_placing[2] 
                camera.rotation.x += camera_placing[3] 
                camera.rotation.y += camera_placing[4] 
                camera.rotation.z += camera_placing[5] 
            }

        </script>

		<script>

            const renderer = new THREE.WebGLRenderer({ antialias: true} )
            document.body.appendChild(renderer.domElement)
			renderer.setSize(window.innerWidth, window.innerHeight)

			const scene = new THREE.Scene()

			const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000)
            place_camera(camera_placings[0])

            // const controls = new THREE.OrbitControls(camera, renderer.domElement)
            // controls.minDistance = 0
            // controls.maxDistance = 99999999

            const controls = new THREE.FirstPersonControls(camera, renderer.domElement)
            controls.movementSpeed = 0
            controls.lookSpeed = 0

            const light = new THREE.AmbientLight()
            light.castShadow = true
            scene.add(light)

			// const geometry = new THREE.BoxGeometry( 1, 1, 1 )
			// const material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } )
			// const cube = new THREE.Mesh( geometry, material )
			// scene.add(cube)

            const loader = new THREE.GLTFLoader()

            var model_shrine
            loader.load('shrine.glb', function ( gltf ) {
                model_shrine = gltf.scene
                model_shrine.rotateY(Math.PI/2)
                scene.add(model_shrine)
            })

            // var model_stairs
            // loader.load('stairs.glb', function ( gltf ) {
            //     model_stairs = gltf.scene
            //     model_stairs.rotateY(-45)
            //     model_stairs.position.y = -6
            //     model_stairs.position.x = -18.6
            //     model_stairs.position.z = -2.8
            //     scene.add(model_stairs)
            // })

            var model_spirit
            loader.load('spirit.glb', function ( gltf ) {
                model_spirit = gltf.scene
                model_spirit.rotateX(Math.PI/2)
                //scene.add(model_spirit)
                mixer = new THREE.AnimationMixer( model_spirit );
				mixer.clipAction( gltf.animations[ 2 ] ).play();
            })
            
            const clock = new THREE.Clock()

            var mixer = null

			function update() {

                var delta = clock.getDelta()

                requestAnimationFrame(update)

                if (mixer!=null) mixer.update(delta * .33)

                controls.update(delta)

                //renderer.clear()
				renderer.render(scene, camera)

                if (recording_flight) console.log(camera.position.x + ' ' + camera.position.y + ' ' + camera.position.z + ' xx ' + camera.rotation.x + ' ' + camera.rotation.y + ' ' + camera.rotation.z)

            } update()

            var recording_flight = false
            document.onkeypress = (e) => {
                var keynum;
                if (window.event) { // IE                  
                    keynum = e.keyCode;
                } else if(e.which) { // Netscape/Firefox/Opera                 
                    keynum = e.which;
                }
                keynum = String.fromCharCode(keynum)
                if (keynum == 'r' || keynum == 'R') recording_flight = true
            }
            document.onkeyup = (e) => {
                var keynum;
                if (window.event) { // IE                  
                    keynum = e.keyCode;
                } else if(e.which) { // Netscape/Firefox/Opera                 
                    keynum = e.which;
                }
                keynum = String.fromCharCode(keynum)
                if (keynum == 'r' || keynum == 'R') recording_flight = false
            }

            const font_loader = new THREE.FontLoader()

            font_loader.load( 'fonts/droid/droid_serif_regular.typeface.json', function ( font ) {
                const geometry = new THREE.TextGeometry( 'Hello world!', {
                    font: font,
                    size: 8,
                    height: 2,
                    // curveSegments: 12,
                    // bevelEnabled: true,
                    // bevelThickness: 10,
                    // bevelSize: 8,
                    // bevelOffset: 0,
                    // bevelSegments: 5
                } )
                const textMesh = new THREE.Mesh( geometry, new THREE.MeshNormalMaterial())
                textMesh.position.x = 17
                textMesh.position.z = 2.6
                textMesh.position.y = .2
                textMesh.rotateY(-Math.PI/2-Math.PI/5)
                textMesh.scale.set(.01,.01,.01)
                scene.add(textMesh)
            } )

		</script>

        <script>

            var username
            var password
            var entity_type

            async function main() {

                var stage_1_completed = false
                var stage_2_completed = false

                var div = document.createElement('div')
                document.body.appendChild(div)
                div.style.alignItems = 'center'
                div.style.justifyContent = 'center'
                div.style.position = 'absolute'
                div.style.top = '50%'
                div.style.left = '50%'
                div.style.transform = 'translate(-50%, -50%)'
                
                var button_login = document.createElement('button')
                var login_mouseover = false
                button_login.innerHTML = 'Login'
                button_login.style.color = 'white'
                button_login.style.padding = '44px'
                button_login.style.border = 'none' //'solid 1px white'
                button_login.style.borderRadius = '10px'
                button_login.style.outline = 'none'
                button_login.style.fontFamily = 'Courier New'
                button_login.style.fontSize = '16px'
                button_login.style.backgroundColor = 'rgba(0,0,0,.44)'
                button_login.onclick = () => {
                    div.removeChild(button_login)
                    div.removeChild(button_empty)
                    div.removeChild(button_guest)

                    var text_username = document.createElement('input')
                    div.appendChild(text_username)
                    text_username.type = 'text'
                    text_username.style.width = '666px'
                    text_username.placeholder = 'username'
                    text_username.style.color = 'white'
                    text_username.style.textAlign = 'center'
                    text_username.style.backgroundColor = 'transparent'
                    text_username.style.border = 'none'
                    text_username.style.outline = 'none'
                    text_username.style.fontSize = '14px'
                    text_username.style.fontFamily = 'Quicksand'
                    text_username.style.backgroundColor = 'rgba(0,0,0,.44)'
                    text_username.style.padding = '6.66px'
                    
                    var text_password = document.createElement('input')
                    div.appendChild(text_password)
                    text_password.type = 'password'
                    text_password.style.width = '666px'
                    text_password.placeholder = 'password'
                    text_password.style.color = 'white'
                    text_password.style.textAlign = 'center'
                    text_password.style.backgroundColor = 'transparent'
                    text_password.style.border = 'none'
                    text_password.style.outline = 'none'
                    text_password.style.fontSize = '14px'
                    text_password.style.fontFamily = 'Quicksand'
                    text_password.style.backgroundColor = 'rgba(0,0,0,.44)'
                    text_password.style.padding = '6.66px'

                    var button_proceed = document.createElement('button')
                    div.appendChild(button_proceed)
                    button_proceed.style.width = '666px'
                    button_proceed.innerHTML = 'Proceed'
                    button_proceed.style.color = 'white'
                    button_proceed.style.backgroundColor = 'transparent'
                    button_proceed.style.border = '2px solid white'
                    button_proceed.style.borderRadius = '20px'
                    button_proceed.style.border = 'none'
                    button_proceed.style.outline = 'none'
                    button_proceed.style.fontSize = '16px'
                    button_proceed.style.fontFamily = 'Quicksand'
                    button_proceed.style.backgroundColor = 'rgba(0,0,0,.44)'
                    button_proceed.style.padding = '6.66px'

                    button_proceed.onclick = function() {
                        document.body.style.cursor = 'wait'
                        if (text_username.value == '' || text_password.value == '') { 
                            alert('Username/Password is not complete.')
                            document.body.style.cursor = 'auto'
                            return
                        }
                        async function go_fetch() {
                            document.body.style.cursor = 'wait'
                            var url = 'https://lisica.lisica.ai:64243/database'
                            var xhr = new XMLHttpRequest();
                            xhr.open("GET", url, true)
                            xhr.setRequestHeader("username", text_username.value)
                            xhr.setRequestHeader("password", text_password.value)
                            xhr.setRequestHeader("cmd", "check_user")
                            xhr.onreadystatechange = function() {
                                if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
                                    var result = JSON.parse(xhr.responseText)
                                    if (result.answer == 'ACK.') {
                                        username = text_username.value
                                        password = text_password.value
                                        div.removeChild(text_username)
                                        div.removeChild(text_password)
                                        div.removeChild(button_proceed)
                                        stage_1_completed = true
                                    } else alert('Username/Password combination invalid.')
                                    document.body.style.cursor = 'auto'
                                }
                            }
                            xhr.send()
                        } go_fetch()
                    }
                }
                button_login.onmouseenter = () => {
                    login_mouseover = true
                    button_login.style.cursor = 'pointer'
                    const work = async () => {
                        var opacity = parseFloat(button_login.style.backgroundColor.split(',')[3].replace(')',''))
                        for (var i = 0; i < 11; i++) {
                            button_login.style.backgroundColor = 'rgba(0,0,0,'+(opacity > .66 ? .66 : opacity).toString()+')'
                            opacity += .02666
                            await sleep(.1)
                            if (!login_mouseover) return
                        }
                    }
                    work()
                }
                button_login.onmouseleave = function() {
                    login_mouseover = false
                    document.body.style.cursor = 'auto'
                    const work = async () => {
                        var opacity = parseFloat(button_login.style.backgroundColor.split(',')[3].replace(')',''))
                        for (var i = 0; i < 11; i++) {
                            button_login.style.backgroundColor = 'rgba(0,0,0,'+(opacity < .44 ? .44 : opacity).toString()+')'
                            opacity -= .02666
                            await sleep(.1)
                            if (login_mouseover) return
                        }
                    }
                    work()
                }
                
                var button_empty = document.createElement('button')
                button_empty.innerHTML = ''
                button_empty.style.color = 'white'
                button_empty.style.padding = '16px'
                button_empty.style.backgroundColor = 'transparent'
                button_empty.style.border = 'none'
                button_empty.style.outline = 'none'
                button_empty.style.fontSize = '16px'
                
                var button_guest = document.createElement('button')
                var guest_mouseover = false
                button_guest.innerHTML = 'Guest'
                button_guest.style.color = 'white'
                button_guest.style.padding = '44px'
                button_guest.style.border = 'none' //'solid 1px white'
                button_guest.style.borderRadius = '10px'
                button_guest.style.outline = 'none'
                button_guest.style.fontFamily = 'Courier New'
                button_guest.style.fontSize = '16px'
                button_guest.style.backgroundColor = 'rgba(0,0,0,.44)'
                button_guest.onclick = () => {
                    stage_1_completed = true
                }
                button_guest.onmouseenter = () => {
                    guest_mouseover = true
                    button_guest.style.cursor = 'pointer'
                    const work = async () => {
                        var opacity = parseFloat(button_guest.style.backgroundColor.split(',')[3].replace(')',''))
                        for (var i = 0; i < 11; i++) {
                            button_guest.style.backgroundColor = 'rgba(0,0,0,'+(opacity > .66 ? .66 : opacity).toString()+')'
                            opacity += .02666
                            await sleep(.1)
                            if (!guest_mouseover) return
                        }
                    }
                    work()
                }
                button_guest.onmouseleave = function() {
                    guest_mouseover = false
                    document.body.style.cursor = 'auto'
                    const work = async () => {
                        var opacity = parseFloat(button_guest.style.backgroundColor.split(',')[3].replace(')',''))
                        for (var i = 0; i < 11; i++) {
                            button_guest.style.backgroundColor = 'rgba(0,0,0,'+(opacity < .44 ? .44 : opacity).toString()+')'
                            opacity -= .02666
                            await sleep(.1)
                            if (guest_mouseover) return
                        }
                    }
                    work()
                }

                div.appendChild(button_login)
                div.appendChild(button_empty)
                div.appendChild(button_guest)

                while (!stage_1_completed) await sleep(.1)

                try {
                    div.removeChild(button_login)
                    div.removeChild(button_empty)
                    div.removeChild(button_guest)
                } catch { }

                var seconds = 2

                for (let i = 0; i < camera_placings.length; i++) {
                    place_camera(camera_placings[i])
                    await sleep(seconds/camera_placings.length)
                }
                place_camera(camera_placings[camera_placings.length-1])

                var button_entity1 = document.createElement('button')
                var entity1_mouseover = false
                button_entity1.innerHTML = 'Entity 1'
                button_entity1.style.color = 'white'
                button_entity1.style.padding = '44px'
                button_entity1.style.border = 'none' //'solid 1px white'
                button_entity1.style.borderRadius = '10px'
                button_entity1.style.outline = 'none'
                button_entity1.style.fontFamily = 'Courier New'
                button_entity1.style.fontSize = '16px'
                button_entity1.style.backgroundColor = 'rgba(0,0,0,.44)'
                button_entity1.onclick = () => {
                    entity_type = 0
                    stage_2_completed = true
                }
                button_entity1.onmouseenter = () => {
                    entity1_mouseover = true
                    button_entity1.style.cursor = 'pointer'
                    const work = async () => {
                        var opacity = parseFloat(button_entity1.style.backgroundColor.split(',')[3].replace(')',''))
                        for (var i = 0; i < 11; i++) {
                            button_entity1.style.backgroundColor = 'rgba(0,0,0,'+(opacity > .6 ? .6 : opacity).toString()+')'
                            opacity += .02666
                            await sleep(.1)
                            if (!entity1_mouseover) return
                        }
                    }
                    work()
                }
                button_entity1.onmouseleave = function() {
                    entity1_mouseover = false
                    document.body.style.cursor = 'auto'
                    const work = async () => {
                        var opacity = parseFloat(button_entity1.style.backgroundColor.split(',')[3].replace(')',''))
                        for (var i = 0; i < 11; i++) {
                            button_entity1.style.backgroundColor = 'rgba(0,0,0,'+(opacity < .44 ? .44 : opacity).toString()+')'
                            opacity -= .02666
                            await sleep(.1)
                            if (entity1_mouseover) return
                        }
                    }
                    work()
                }
                
                var button_empty = document.createElement('button')
                button_empty.innerHTML = ''
                button_empty.style.color = 'white'
                button_empty.style.padding = '16px'
                button_empty.style.backgroundColor = 'transparent'
                button_empty.style.border = 'none'
                button_empty.style.outline = 'none'
                button_empty.style.fontSize = '16px'
                
                var button_entity2 = document.createElement('button')
                var entity2_mouseover = false
                button_entity2.innerHTML = 'Entity 2'
                button_entity2.style.color = 'white'
                button_entity2.style.padding = '44px'
                button_entity2.style.border = 'none' //'solid 1px white'
                button_entity2.style.borderRadius = '10px'
                button_entity2.style.outline = 'none'
                button_entity2.style.fontFamily = 'Courier New'
                button_entity2.style.fontSize = '16px'
                button_entity2.style.backgroundColor = 'rgba(0,0,0,.44)'
                button_entity2.onclick = () => {
                    entity_type = 1
                    stage_2_completed = true
                }
                button_entity2.onmouseenter = () => {
                    entity2_mouseover = true
                    button_entity2.style.cursor = 'pointer'
                    const work = async () => {
                        var opacity = parseFloat(button_entity2.style.backgroundColor.split(',')[3].replace(')',''))
                        for (var i = 0; i < 11; i++) {
                            button_entity2.style.backgroundColor = 'rgba(0,0,0,'+(opacity > .6 ? .6 : opacity).toString()+')'
                            opacity += .02666
                            await sleep(.1)
                            if (!entity2_mouseover) return
                        }
                    }
                    work()
                }
                button_entity2.onmouseleave = function() {
                    entity2_mouseover = false
                    document.body.style.cursor = 'auto'
                    const work = async () => {
                        var opacity = parseFloat(button_entity2.style.backgroundColor.split(',')[3].replace(')',''))
                        for (var i = 0; i < 11; i++) {
                            button_entity2.style.backgroundColor = 'rgba(0,0,0,'+(opacity < .44 ? .44 : opacity).toString()+')'
                            opacity -= .02666
                            await sleep(.1)
                            if (entity2_mouseover) return
                        }
                    }
                    work()
                }

                var button_empty2 = document.createElement('button')
                button_empty2.innerHTML = ''
                button_empty2.style.color = 'white'
                button_empty2.style.padding = '16px'
                button_empty2.style.backgroundColor = 'transparent'
                button_empty2.style.border = 'none'
                button_empty2.style.outline = 'none'
                button_empty2.style.fontSize = '16px'

                var button_entity3 = document.createElement('button')
                var entity3_mouseover = false
                button_entity3.innerHTML = 'Entity 3'
                button_entity3.style.color = 'white'
                button_entity3.style.padding = '44px'
                button_entity3.style.border = 'none' //'solid 1px white'
                button_entity3.style.borderRadius = '10px'
                button_entity3.style.outline = 'none'
                button_entity3.style.fontFamily = 'Courier New'
                button_entity3.style.fontSize = '16px'
                button_entity3.style.backgroundColor = 'rgba(0,0,0,.44)'
                button_entity3.onclick = () => {
                    entity_type = 2
                    stage_2_completed = true
                }
                button_entity3.onmouseenter = () => {
                    entity3_mouseover = true
                    button_entity3.style.cursor = 'pointer'
                    const work = async () => {
                        var opacity = parseFloat(button_entity3.style.backgroundColor.split(',')[3].replace(')',''))
                        for (var i = 0; i < 11; i++) {
                            button_entity3.style.backgroundColor = 'rgba(0,0,0,'+(opacity > .6 ? .6 : opacity).toString()+')'
                            opacity += .02666
                            await sleep(.1)
                            if (!entity3_mouseover) return
                        }
                    }
                    work()
                }
                button_entity3.onmouseleave = function() {
                    entity3_mouseover = false
                    document.body.style.cursor = 'auto'
                    const work = async () => {
                        var opacity = parseFloat(button_entity3.style.backgroundColor.split(',')[3].replace(')',''))
                        for (var i = 0; i < 11; i++) {
                            button_entity3.style.backgroundColor = 'rgba(0,0,0,'+(opacity < .44 ? .44 : opacity).toString()+')'
                            opacity -= .02666
                            await sleep(.1)
                            if (entity3_mouseover) return
                        }
                    }
                    work()
                }
                
                div.appendChild(button_entity1)
                div.appendChild(button_empty)
                div.appendChild(button_entity2)
                div.appendChild(button_empty2)
                div.appendChild(button_entity3)

                while (!stage_2_completed) await sleep(.1)

                div.removeChild(button_entity1)
                div.removeChild(button_empty)
                div.removeChild(button_entity2)
                div.removeChild(button_empty2)
                div.removeChild(button_entity3)

                scene.add(model_spirit)
                model_spirit.position.x = camera_placings[camera_placings.length-1][0] + .936
                model_spirit.position.y = camera_placings[camera_placings.length-1][1] - .666
                model_spirit.position.z = camera_placings[camera_placings.length-1][2] - 3.666
                model_spirit.rotateZ(Math.PI/20)

            } main()

        </script>

        <script>

            // Todo: do the entity talking thingy here



        </script>

	</body>

</html>
