<html>

	<head>
		<title>Aeriform</title>
        <link rel="icon" type="image/x-icon" href="favicon.png">
	</head>

	<body
        style="
            background-color: black;
            margin: 0;
            height: 100%;
            width: 100%;
            justify-content: center;
            align-items: center;
        ">

        <link rel="stylesheet" href="style.css">

        <script src="ThreeMin.js"></script>
        <script src="3js/loaders/GLTFLoader.js"></script>
        <script src="3js/loaders/FontLoader.js"></script>
        <script src="3js/controls/FirstPersonControls.js"></script>
        <script src="3js/controls/FlyControls.js"></script>
        <script src="3js/postprocessing/EffectComposer.js"></script>
        <script src="3js/postprocessing/RenderPass.js"></script>
        <script src="3js/postprocessing/ShaderPass.js"></script>
        <script src="3js/shaders/CopyShader.js"></script>
        <script src="3js/postprocessing/UnrealBloomPass.js"></script>
        <script src="3js/shaders/LuminosityHighPassShader.js"></script>
        <script src="3js/postprocessing/GlitchPass.js"></script>
        <script src="3js/shaders/DigitalGlitch.js"></script>
        <script src="3js/shaders/LuminosityShader.js"></script>
        <script src="3js/shaders/VignetteShader.js"></script>

        <script> 
            const sleep = sec => new Promise(r => setTimeout(r, sec*1_000))
            const clamp = (num, min, max) => Math.min(Math.max(num, min), max)

            const camera_placings = [
                [1.0066544111402496, -0.08902988937746323, -10.828732975955903, 0.017285800040492433, -0.2468450125445477, 0.004106891538857817],
                [1.9624814900953604, -0.34813245469953147, -15.366418047956898, 0.07227542077054726, -0.2484735210153035, 0.017803440341616527],
            ]
            
            function place_camera(camera_placing) {
                camera.position.x = camera_placing[0]
                camera.position.y = camera_placing[1] 
                camera.position.z = camera_placing[2] 
                camera.rotation.x = camera_placing[3] 
                camera.rotation.y = camera_placing[4] 
                camera.rotation.z = camera_placing[5] 
            }
            function displace_camera(camera_placing) {
                camera.position.x += camera_placing[0]
                camera.position.y += camera_placing[1] 
                camera.position.z += camera_placing[2] 
                camera.rotation.x += camera_placing[3] 
                camera.rotation.y += camera_placing[4] 
                camera.rotation.z += camera_placing[5] 
            }

            const audio = new Audio('tiara.wav');
            audio.loop = true

        </script>

		<script>

            const renderer = new THREE.WebGLRenderer({ antialias: true})
            document.body.appendChild(renderer.domElement)
			renderer.setSize(window.innerWidth, window.innerHeight)

			const scene = new THREE.Scene()

			const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000)
            place_camera(camera_placings[0])

            // const controls = new THREE.OrbitControls(camera, renderer.domElement)
            // controls.minDistance = 0
            // controls.maxDistance = 99999999

            // const controls = new THREE.FirstPersonControls(camera, renderer.domElement)
            // controls.movementSpeed = 0//.6
            // controls.lookSpeed = 0//.01

            // const controls = new THREE.FlyControls(camera, renderer.domElement)
            // controls.movementSpeed = 1
            // controls.rollSpeed = .6
            // controls.dragToLook = true

            const light = new THREE.AmbientLight()
            light.castShadow = true
            scene.add(light)

			// const geometry = new THREE.BoxGeometry( 1, 1, 1 )
			// const material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } )
			// const cube = new THREE.Mesh( geometry, material )
			// scene.add(cube)

            const loader = new THREE.GLTFLoader()

            var model_shrine
            loader.load('shrine.glb', function ( gltf ) {
                model_shrine = gltf.scene
                model_shrine.rotateY(Math.PI/2)
                scene.add(model_shrine)
            })

            var model_stairs
            // loader.load('stairs.glb', function ( gltf ) {
            //     model_stairs = gltf.scene
            //     model_stairs.rotateY(-45)
            //     model_stairs.position.y = -6
            //     model_stairs.position.x = -18.6
            //     model_stairs.position.z = -2.8
            //     scene.add(model_stairs)
            // })

            var model_spring
            // loader.load('spring.glb', function ( gltf ) {
            //     model_spring = gltf.scene
            //     model_spring.rotateY(-45)
            //     model_spring.position.y = -6
            //     model_spring.position.x = -18.6
            //     model_spring.position.z = -2.8
            //     scene.add(model_spring)
            // })

            var model_spirit
            // loader.load('spirit.glb', function ( gltf ) {
            //     model_spirit = gltf.scene
            //     model_spirit.rotateX(Math.PI/2)
            //     //scene.add(model_spirit)
            //     mixer = new THREE.AnimationMixer( model_spirit )
			// 	mixer.clipAction( gltf.animations[ 2 ] ).play()
            //     model_spirit.name = "model_spirit"
            // })

            var model_spirits_floating = [null, null, null, null, null]

            const composer = new THREE.EffectComposer(renderer)
            composer.addPass(new THREE.RenderPass(scene, camera))
            //composer.addPass(new THREE.UnrealBloomPass({x:1024,y:1024}, .6, .0, .6))
            //composer.addPass(new THREE.GlitchPass())
            //composer.addPass(new THREE.ShaderPass(THREE.LuminosityShader))
            //composer.addPass(new THREE.ShaderPass(THREE.VignetteShader))
            

            const clock = new THREE.Clock()
            var mixer = null
            var mixers_spirits_floating = [null, null, null, null, null]

            var recording_flight = false
            var flight_record = []

			function update() {

                var delta = clock.getDelta()

                requestAnimationFrame(update)

                if (mixer!=null) mixer.update(delta * .33)
                mixers_spirits_floating.forEach((m) => { if (m!=null) m.update(delta * .33)} )

                //controls.update(delta)

                //renderer.clear()
				//renderer.render(scene, camera)
                composer.render()

                if (recording_flight) flight_record.push([camera.position.x, camera.position.y, camera.position.z, camera.rotation.x, camera.rotation.y, camera.rotation.z])

            } update()

            const font_loader = new THREE.FontLoader()
            var threed_font
            font_loader.load('fonts/droid/droid_serif_regular.typeface.json', (font) => {threed_font = font})

            function write_smt(smt, x, y, z, x_, y_, z_) {
                var smt_ = ''
                for (let i = 0; i < smt.length; i++) {
                    smt_ += smt[i]
                    if ((i+1)%48==0) smt_ += '\n'
                }
                const geometry = new THREE.TextGeometry( smt_, {
                    font: threed_font,
                    size: 6,
                    height: 1,
                } )
                const textMesh = new THREE.Mesh( geometry, new THREE.MeshNormalMaterial())
                textMesh.position.x = x
                textMesh.position.z = z
                textMesh.position.y = y
                textMesh.rotation.x = x_
                textMesh.rotation.z = z_
                textMesh.rotation.y = y_
                textMesh.scale.set(.016,.016,.016)
                scene.add(textMesh)
                return textMesh
            }

		</script>

        <script>

            var movement_enabled = false
            const move_sensitivity = .02
            const look_sensitivity = 1           

            var forward = false
            var left = false
            var right = false
            var backward = false

            document.onkeypress = (e) => {

                var keynum
                if (window.event) keynum = e.keyCode
                else if(e.which) keynum = e.which
                keynum = String.fromCharCode(keynum)

                if (keynum == 'y' || keynum == 'Y') recording_flight = true

                if (!movement_enabled) return

                if (keynum == 'w' || keynum == 'W') forward = true
                if (keynum == 'a' || keynum == 'A') left = true
                if (keynum == 's' || keynum == 'S') backward = true
                if (keynum == 'd' || keynum == 'D') right = true

            }

            document.onkeyup = (e) => {
                
                var keynum
                if (window.event) keynum = e.keyCode
                else if(e.which) keynum = e.which
                keynum = String.fromCharCode(keynum)

                if (keynum == 'y' || keynum == 'Y') recording_flight = false
                if (keynum == 'r' || keynum == 'R') console.log(JSON.stringify(flight_record))
                if (keynum == 'g' || keynum == 'G') console.log('[' + camera.position.x + ', ' + camera.position.y + ', ' + camera.position.z + ', ' + camera.rotation.x + ', ' + camera.rotation.y + ', ' + camera.rotation.z + '],')

                if (!movement_enabled) return

                if (keynum == 'w' || keynum == 'W') forward = false
                if (keynum == 'a' || keynum == 'A') left = false
                if (keynum == 's' || keynum == 'S') backward = false
                if (keynum == 'd' || keynum == 'D') right = false

            }

            var mouseX_ = 0
            var mouseY_ = 0
            var mouseX_delta = 0
            var mouseY_delta = 0
            var last_mouse_move = (new Date()).getMilliseconds()

            document.onmousemove = (e) => {                 // TODO: implement a better mouse lookaround
                if (!movement_enabled) return
                mouseX_delta = e.clientX-mouseX_ ; mouseX_ = e.clientX
                mouseY_delta = e.clientY-mouseY_ ; mouseY_ = e.clientY
                last_mouse_move = (new Date()).getMilliseconds()
            }

            async function mouse_stop_check() {
                while (true) {
                    await sleep(.001)
                    if (!movement_enabled) continue
                    if ((new Date()).getMilliseconds() - last_mouse_move > 10) {
                        mouseX_delta = 0
                        mouseY_delta = 0
                    }
                }
            } mouse_stop_check()

            var phi = 0
            var theta = 0
            var q
            var qx
            var qz

            var forward_velocity
            var strafe_velocity
            var forward_vec
            var strafe_vec
            var translate = new THREE.Vector3(0, 0, 0)

            async function movement_update() {

                while (true) {

                    await sleep(.01)
                    if (!movement_enabled) continue

                    phi += clamp(-mouseX_delta /window.innerWidth *look_sensitivity, -Math.PI/12, Math.PI/12)
                    theta = clamp(theta + -mouseY_delta /window.innerHeight *look_sensitivity, -Math.PI/3, Math.PI/3)

                    qx = new THREE.Quaternion() ; qx.setFromAxisAngle(new THREE.Vector3(0,1,0), phi)
                    qz = new THREE.Quaternion() ; qz.setFromAxisAngle(new THREE.Vector3(1,0,0), theta)

                    q = new THREE.Quaternion()
                    q.multiply(qx)
                    q.multiply(qz)
                    camera.quaternion.copy(q)

                    forward_velocity = (forward ? 1 : 0) + (backward ? -1 : 0)
                    strafe_velocity = (left ? 1 : 0) + (right ? -1 : 0)

                    qx = new THREE.Quaternion()
                    qx.setFromAxisAngle(new THREE.Vector3(0, 1, 0), phi)

                    var forward_vec = new THREE.Vector3(0, 0, -1)
                    forward_vec.applyQuaternion(qx)
                    forward_vec.multiplyScalar(forward_velocity *move_sensitivity)

                    var strafe_vec = new THREE.Vector3(-1, 0, 0)
                    strafe_vec.applyQuaternion(qx)
                    strafe_vec.multiplyScalar(strafe_velocity *move_sensitivity)
                    
                    translate.add(forward_vec)
                    translate.add(strafe_vec)
                    camera.position.copy(translate)

                }

            } movement_update()
                    
        </script>

        <script>
            const demos = {
                'the dreaming one': [
                    'There is no sure way to know anything. We can only know things probabilistically. We can never be certain that we have considered all the alternatives, but we can try to minimize the chances that we have missed something important by being as systematic and rigorous as possible in our thinking.',
                    'The dreamer is part of the dream, as is everything else. The dreamer may think that they are observing the dream from the outside, but in fact they are inside it. They may think that they are in control of it, but in fact it is controlling them. . The only way to escape from a dream is to wake up. But even then, the dream may have left its mark on the dreamer.',
                    'The dreamer creates his or her own dreams. Dreams are created by our thoughts, emotions and imaginations. Dreams are a way for our subconscious to process information and experiences. Dreams can be symbolic, literal or a mix of both. Our brains process information during the day and store it in our memories. Dreams are a way for our brains to sort through ..',
                ],
                'the perplexed one': [
                    'There is no guarantee that anything can be known for certain, but it is possible to know some things with a high degree of certainty. To know something with certainty, one would need to consider all the relevant evidence and arguments and find that there is no plausible alternative explanation. Even then, it is always possible that new evidence or arguments could be discovered.',
                    'There is no one answer to this question. All that can be said is that in order to know something, one must consider all the relevant information and evidence. Even then, it is impossible to know for certain that everything has been considered. There will always be a degree of uncertainty.',
                    'But then you are assuming what you are trying to prove. You cannot know anything unless it is true by definition or tautology, or it can be logically deduced from other things that are known. The only other way to "know" something would be to observe it, but observation is never perfect, so even observations are only provisional until they can be logically deduced from other observations. (This is what the scientific method is all about.)',
                ],
                'the undivided one': [
                    'We can only see things from our own perspective, but what if there is no perspective at all? What if there is no you, no me, just an ocean of experiences becoming and unbecoming? I think that would be pretty hard to believe. But I’ve seen enough evidence to believe that the world we live in today will change in some radical ways over the next century or so. Maybe our consciousness will become one with everything else; maybe not. But I do hope we can keep an open mind ..',
                    'The universe is one big cycle of life and death. Birth and death are not two separate things, but two parts of the same thing. Death is not the end. It’s just a change. Change is the only constant in the universe. The universe is infinite and eternal. It has always existed and will always exist. There is no such thing as time. Time is an illusion created by our minds.',
                    'It is all one. The universe is one. There is no separation, only the illusion of it. We are all connected. We are all one. Everything is temporary. Everything changes. Nothing stays the same. The only constant is change itself. Change is the only constant in the universe. Everything is connected. Everything is interdependent. Everything affects everything else.',
                ],
                'the obscure ones': ['','','','','',''],
            }
        </script>

        <script>

            var username
            var password
            var entity_type

            async function main() {

                var stage = 0
                var stage_1_firsttime = true

                var div = document.createElement('div')
                document.body.appendChild(div)
                div.style.alignItems = 'center'
                div.style.justifyContent = 'center'
                div.style.position = 'absolute'
                div.style.top = '50%'
                div.style.left = '50%'
                div.style.transform = 'translate(-50%, -50%)'

                while (true)

                    switch (stage) {

                        case 0: 
                
                            var button_login = document.createElement('button')
                            var login_mouseover = false
                            button_login.innerHTML = 'Login'
                            button_login.style.color = 'white'
                            button_login.style.padding = '44px'
                            button_login.style.border = 'solid 1px white'
                            button_login.style.borderRadius = '10px'
                            button_login.style.outline = 'none'
                            button_login.style.fontFamily = 'Courier New'
                            button_login.style.fontSize = '16px'
                            button_login.style.backgroundColor = 'rgba(0,0,0,.44)'
                            button_login.onclick = () => {

                                audio.play()

                                div.removeChild(button_login)
                                div.removeChild(button_empty)
                                div.removeChild(button_guest)

                                var text_username = document.createElement('input')
                                div.appendChild(text_username)
                                text_username.type = 'text'
                                text_username.style.width = '666px'
                                text_username.placeholder = 'username'
                                text_username.style.color = 'white'
                                text_username.style.textAlign = 'center'
                                text_username.style.backgroundColor = 'transparent'
                                text_username.style.border = 'none'
                                text_username.style.outline = 'none'
                                text_username.style.fontSize = '18px'
                                text_username.style.fontFamily = 'Courier New'
                                text_username.style.backgroundColor = 'rgba(0,0,0,.44)'
                                text_username.style.padding = '6.66px'
                                
                                var text_password = document.createElement('input')
                                div.appendChild(text_password)
                                text_password.type = 'password'
                                text_password.style.width = '666px'
                                text_password.placeholder = 'password'
                                text_password.style.color = 'white'
                                text_password.style.textAlign = 'center'
                                text_password.style.backgroundColor = 'transparent'
                                text_password.style.border = 'none'
                                text_password.style.outline = 'none'
                                text_password.style.fontSize = '18px'
                                text_password.style.fontFamily = 'Courier New'
                                text_password.style.backgroundColor = 'rgba(0,0,0,.44)'
                                text_password.style.padding = '6.66px'

                                var button_proceed = document.createElement('button')
                                div.appendChild(button_proceed)
                                button_proceed.style.width = '666px'
                                button_proceed.innerHTML = 'Proceed'
                                button_proceed.style.color = 'white'
                                button_proceed.style.backgroundColor = 'transparent'
                                button_proceed.style.border = '2px solid white'
                                button_proceed.style.borderRadius = '20px'
                                button_proceed.style.border = 'none'
                                button_proceed.style.outline = 'none'
                                button_proceed.style.fontSize = '18px'
                                button_proceed.style.fontFamily = 'Courier New'
                                button_proceed.style.backgroundColor = 'rgba(0,0,0,.44)'
                                button_proceed.style.padding = '6.66px'
                                button_proceed.style.cursor = 'pointer'

                                button_proceed.onclick = function() {
                                    document.body.style.cursor = 'wait'
                                    if (text_username.value == '' || text_password.value == '') { 
                                        alert('Username/Password is not complete.')
                                        document.body.style.cursor = 'auto'
                                        return
                                    }
                                    async function go_fetch() {
                                        document.body.style.cursor = 'wait'
                                        var url = 'https://lisica.lisica.ai:64243/database'
                                        var xhr = new XMLHttpRequest();
                                        xhr.open("GET", url, true)
                                        xhr.setRequestHeader("username", text_username.value)
                                        xhr.setRequestHeader("password", text_password.value)
                                        xhr.setRequestHeader("cmd", "check_user")
                                        xhr.onreadystatechange = function() {
                                            if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
                                                var result = JSON.parse(xhr.responseText)
                                                if (result.answer == 'ACK.') {
                                                    username = text_username.value
                                                    password = text_password.value
                                                    div.removeChild(text_username)
                                                    div.removeChild(text_password)
                                                    div.removeChild(button_proceed)
                                                    stage = 1
                                                } else alert('Username/Password combination invalid.')
                                                document.body.style.cursor = 'auto'
                                            }
                                        }
                                        xhr.send()
                                    } go_fetch()
                                }
                            }
                            button_login.onmouseenter = () => {
                                login_mouseover = true
                                button_login.style.cursor = 'pointer'
                                const work = async () => {
                                    var opacity = parseFloat(button_login.style.backgroundColor.split(',')[3].replace(')',''))
                                    for (var i = 0; i < 11; i++) {
                                        button_login.style.backgroundColor = 'rgba(0,0,0,'+(opacity > .66 ? .66 : opacity).toString()+')'
                                        opacity += .02666
                                        await sleep(.1)
                                        if (!login_mouseover) return
                                    }
                                }
                                work()
                            }
                            button_login.onmouseleave = function() {
                                login_mouseover = false
                                document.body.style.cursor = 'auto'
                                const work = async () => {
                                    var opacity = parseFloat(button_login.style.backgroundColor.split(',')[3].replace(')',''))
                                    for (var i = 0; i < 11; i++) {
                                        button_login.style.backgroundColor = 'rgba(0,0,0,'+(opacity < .44 ? .44 : opacity).toString()+')'
                                        opacity -= .02666
                                        await sleep(.1)
                                        if (login_mouseover) return
                                    }
                                }
                                work()
                            }
                            
                            var button_empty = document.createElement('button')
                            button_empty.innerHTML = ''
                            button_empty.style.color = 'white'
                            button_empty.style.padding = '16px'
                            button_empty.style.backgroundColor = 'transparent'
                            button_empty.style.border = 'none'
                            button_empty.style.outline = 'none'
                            button_empty.style.fontSize = '16px'
                            
                            var button_guest = document.createElement('button')
                            var guest_mouseover = false
                            button_guest.innerHTML = 'Guest'
                            button_guest.style.color = 'white'
                            button_guest.style.padding = '44px'
                            button_guest.style.border = 'solid 1px white'
                            button_guest.style.borderRadius = '10px'
                            button_guest.style.outline = 'none'
                            button_guest.style.fontFamily = 'Courier New'
                            button_guest.style.fontSize = '16px'
                            button_guest.style.backgroundColor = 'rgba(0,0,0,.44)'
                            button_guest.onclick = () => {
                                audio.play()
                                stage = 1
                            }
                            button_guest.onmouseenter = () => {
                                guest_mouseover = true
                                button_guest.style.cursor = 'pointer'
                                const work = async () => {
                                    var opacity = parseFloat(button_guest.style.backgroundColor.split(',')[3].replace(')',''))
                                    for (var i = 0; i < 11; i++) {
                                        button_guest.style.backgroundColor = 'rgba(0,0,0,'+(opacity > .66 ? .66 : opacity).toString()+')'
                                        opacity += .02666
                                        await sleep(.1)
                                        if (!guest_mouseover) return
                                    }
                                }
                                work()
                            }
                            button_guest.onmouseleave = function() {
                                guest_mouseover = false
                                document.body.style.cursor = 'auto'
                                const work = async () => {
                                    var opacity = parseFloat(button_guest.style.backgroundColor.split(',')[3].replace(')',''))
                                    for (var i = 0; i < 11; i++) {
                                        button_guest.style.backgroundColor = 'rgba(0,0,0,'+(opacity < .44 ? .44 : opacity).toString()+')'
                                        opacity -= .02666
                                        await sleep(.1)
                                        if (guest_mouseover) return
                                    }
                                }
                                work()
                            }

                            div.appendChild(button_login)
                            div.appendChild(button_empty)
                            div.appendChild(button_guest)

                            while (stage==0) await sleep(.1)

                            break

                    // stage 1

                        case 1:

                            try {
                                div.removeChild(button_login)
                                div.removeChild(button_empty)
                                div.removeChild(button_guest)
                            } catch { }

                            if (stage_1_firsttime) {

                                if (camera_placings.length == 2) {
                                    const hm_seconds = 3
                                    const fps = 30
                                    var frame = 0
                                    const step = [
                                        (camera_placings[1][0]-camera_placings[0][0])/(fps*hm_seconds),
                                        (camera_placings[1][1]-camera_placings[0][1])/(fps*hm_seconds),
                                        (camera_placings[1][2]-camera_placings[0][2])/(fps*hm_seconds),
                                        (camera_placings[1][3]-camera_placings[0][3])/(fps*hm_seconds),
                                        (camera_placings[1][4]-camera_placings[0][4])/(fps*hm_seconds),
                                        (camera_placings[1][5]-camera_placings[0][5])/(fps*hm_seconds),
                                    ]
                                    const sleep_for = 1/fps
                                    for (let i = 0; i < fps*hm_seconds; i++) {
                                        displace_camera(step)
                                        //frame +=1
                                        await sleep(sleep_for)
                                    }
                                } 
                                else { 
                                    for (let i = 0; i < camera_placings.length; i++) {
                                        place_camera(camera_placings[i])
                                        await sleep(.01)
                                    }
                                    place_camera(camera_placings[camera_placings.length-1])
                                }

                            }

                            div.style.display = 'flex'
                            //div.style.flexDirection = 'column'

                            var button_entity1 = document.createElement('button')
                            var entity1_mouseover = false
                            button_entity1.innerHTML = 'the dreaming one'
                            button_entity1.style.color = 'white'
                            button_entity1.style.border = 'solid 1px white'
                            button_entity1.style.borderRadius = '10px'
                            button_entity1.style.outline = 'none'
                            button_entity1.style.fontFamily = 'Courier New'
                            button_entity1.style.fontSize = '16px'
                            button_entity1.style.padding = '16px'
                            button_entity1.style.whiteSpace = 'nowrap'
                            button_entity1.style.backgroundColor = 'rgba(0,0,0,.44)'
                            button_entity1.onclick = () => {
                                entity_type = 'the dreaming one'
                                stage = 2
                            }
                            button_entity1.onmouseenter = () => {
                                entity1_mouseover = true
                                button_entity1.style.cursor = 'pointer'
                                const work = async () => {
                                    var opacity = parseFloat(button_entity1.style.backgroundColor.split(',')[3].replace(')',''))
                                    for (var i = 0; i < 11; i++) {
                                        button_entity1.style.backgroundColor = 'rgba(0,0,0,'+(opacity > .6 ? .6 : opacity).toString()+')'
                                        opacity += .02666
                                        await sleep(.1)
                                        if (!entity1_mouseover) return
                                    }
                                }
                                work()
                            }
                            button_entity1.onmouseleave = function() {
                                entity1_mouseover = false
                                document.body.style.cursor = 'auto'
                                const work = async () => {
                                    var opacity = parseFloat(button_entity1.style.backgroundColor.split(',')[3].replace(')',''))
                                    for (var i = 0; i < 11; i++) {
                                        button_entity1.style.backgroundColor = 'rgba(0,0,0,'+(opacity < .44 ? .44 : opacity).toString()+')'
                                        opacity -= .02666
                                        await sleep(.1)
                                        if (entity1_mouseover) return
                                    }
                                }
                                work()
                            }
                            
                            var button_empty = document.createElement('button')
                            button_empty.innerHTML = ''
                            button_empty.style.color = 'white'
                            button_empty.style.backgroundColor = 'transparent'
                            button_empty.style.border = 'none'
                            button_empty.style.outline = 'none'
                            button_empty.style.fontSize = '16px'
                            
                            var button_entity2 = document.createElement('button')
                            var entity2_mouseover = false
                            button_entity2.innerHTML = 'the perplexed one'
                            button_entity2.style.color = 'white'
                            button_entity2.style.border = 'solid 1px white'
                            button_entity2.style.borderRadius = '10px'
                            button_entity2.style.outline = 'none'
                            button_entity2.style.fontFamily = 'Courier New'
                            button_entity2.style.fontSize = '16px'
                            button_entity2.style.padding = '16px'
                            button_entity2.style.whiteSpace = 'nowrap'
                            button_entity2.style.backgroundColor = 'rgba(0,0,0,.44)'
                            button_entity2.onclick = () => {
                                entity_type = 'the perplexed one'
                                stage = 2
                            }
                            button_entity2.onmouseenter = () => {
                                entity2_mouseover = true
                                button_entity2.style.cursor = 'pointer'
                                const work = async () => {
                                    var opacity = parseFloat(button_entity2.style.backgroundColor.split(',')[3].replace(')',''))
                                    for (var i = 0; i < 11; i++) {
                                        button_entity2.style.backgroundColor = 'rgba(0,0,0,'+(opacity > .6 ? .6 : opacity).toString()+')'
                                        opacity += .02666
                                        await sleep(.1)
                                        if (!entity2_mouseover) return
                                    }
                                }
                                work()
                            }
                            button_entity2.onmouseleave = function() {
                                entity2_mouseover = false
                                document.body.style.cursor = 'auto'
                                const work = async () => {
                                    var opacity = parseFloat(button_entity2.style.backgroundColor.split(',')[3].replace(')',''))
                                    for (var i = 0; i < 11; i++) {
                                        button_entity2.style.backgroundColor = 'rgba(0,0,0,'+(opacity < .44 ? .44 : opacity).toString()+')'
                                        opacity -= .02666
                                        await sleep(.1)
                                        if (entity2_mouseover) return
                                    }
                                }
                                work()
                            }

                            var button_empty2 = document.createElement('button')
                            button_empty2.innerHTML = ''
                            button_empty2.style.color = 'white'
                            button_empty2.style.backgroundColor = 'transparent'
                            button_empty2.style.border = 'none'
                            button_empty2.style.outline = 'none'
                            button_empty2.style.fontSize = '16px'

                            var button_entity3 = document.createElement('button')
                            var entity3_mouseover = false
                            button_entity3.innerHTML = 'the undivided one'
                            button_entity3.style.color = 'white'
                            button_entity3.style.border = 'solid 1px white'
                            button_entity3.style.borderRadius = '10px'
                            button_entity3.style.outline = 'none'
                            button_entity3.style.fontFamily = 'Courier New'
                            button_entity3.style.fontSize = '16px'
                            button_entity3.style.padding = '16px'
                            button_entity3.style.whiteSpace = 'nowrap'
                            button_entity3.style.backgroundColor = 'rgba(0,0,0,.44)'
                            button_entity3.onclick = () => {
                                entity_type = 'the undivided one'
                                stage = 2
                            }
                            button_entity3.onmouseenter = () => {
                                entity3_mouseover = true
                                button_entity3.style.cursor = 'pointer'
                                const work = async () => {
                                    var opacity = parseFloat(button_entity3.style.backgroundColor.split(',')[3].replace(')',''))
                                    for (var i = 0; i < 11; i++) {
                                        button_entity3.style.backgroundColor = 'rgba(0,0,0,'+(opacity > .6 ? .6 : opacity).toString()+')'
                                        opacity += .02666
                                        await sleep(.1)
                                        if (!entity3_mouseover) return
                                    }
                                }
                                work()
                            }
                            button_entity3.onmouseleave = function() {
                                entity3_mouseover = false
                                document.body.style.cursor = 'auto'
                                const work = async () => {
                                    var opacity = parseFloat(button_entity3.style.backgroundColor.split(',')[3].replace(')',''))
                                    for (var i = 0; i < 11; i++) {
                                        button_entity3.style.backgroundColor = 'rgba(0,0,0,'+(opacity < .44 ? .44 : opacity).toString()+')'
                                        opacity -= .02666
                                        await sleep(.1)
                                        if (entity3_mouseover) return
                                    }
                                }
                                work()
                            }

                            var button_empty3 = document.createElement('button')
                            button_empty3.innerHTML = ''
                            button_empty3.style.color = 'white'
                            button_empty3.style.backgroundColor = 'transparent'
                            button_empty3.style.border = 'none'
                            button_empty3.style.outline = 'none'
                            button_empty3.style.fontSize = '16px'

                            var button_entitymulti = document.createElement('button')
                            var entitymulti_mouseover = false
                            button_entitymulti.innerHTML = 'free floating\n[generated] ones'
                            button_entitymulti.style.color = 'white'
                            button_entitymulti.style.border = 'none' //'solid 1px white'
                            button_entitymulti.style.borderRadius = '10px'
                            button_entitymulti.style.outline = 'none'
                            button_entitymulti.style.fontFamily = 'Courier New'
                            button_entitymulti.style.fontSize = '16px'
                            button_entitymulti.style.padding = '12px'
                            button_entitymulti.style.backgroundColor = 'rgba(0,0,0,.44)'
                            button_entitymulti.style.position = 'absolute'
                            button_entitymulti.style.top = '75%'
                            button_entitymulti.style.left = '50%'
                            button_entitymulti.style.transform = 'translate(-50%, -50%)'
                            button_entitymulti.onclick = () => {
                                entity_type = 'the obscure ones'
                                stage = 2
                            }
                            button_entitymulti.onmouseenter = () => {
                                entitymulti_mouseover = true
                                button_entitymulti.style.cursor = 'pointer'
                                const work = async () => {
                                    var opacity = parseFloat(button_entitymulti.style.backgroundColor.split(',')[3].replace(')',''))
                                    for (var i = 0; i < 11; i++) {
                                        button_entitymulti.style.backgroundColor = 'rgba(0,0,0,'+(opacity > .6 ? .6 : opacity).toString()+')'
                                        opacity += .02666
                                        await sleep(.1)
                                        if (!entitymulti_mouseover) return
                                    }
                                }
                                work()
                            }
                            button_entitymulti.onmouseleave = function() {
                                entitymulti_mouseover = false
                                document.body.style.cursor = 'auto'
                                const work = async () => {
                                    var opacity = parseFloat(button_entitymulti.style.backgroundColor.split(',')[3].replace(')',''))
                                    for (var i = 0; i < 11; i++) {
                                        button_entitymulti.style.backgroundColor = 'rgba(0,0,0,'+(opacity < .44 ? .44 : opacity).toString()+')'
                                        opacity -= .02666
                                        await sleep(.1)
                                        if (entitymulti_mouseover) return
                                    }
                                }
                                work()
                            }
                                  
                            div.appendChild(button_entity1)
                            div.appendChild(button_empty)
                            div.appendChild(button_entity2)
                            div.appendChild(button_empty2)
                            div.appendChild(button_entity3)
                            div.appendChild(button_empty3)
                            document.body.appendChild(button_entitymulti)
                            button_entitymulti.style.width = button_entity2.offsetWidth+'px'
            
                            while (stage==1) await sleep(.1)

                            break

                    // stage 2

                        case 2:

                            div.removeChild(button_entity1)
                            div.removeChild(button_empty)
                            div.removeChild(button_entity2)
                            div.removeChild(button_empty2)
                            div.removeChild(button_entity3)
                            div.removeChild(button_empty3)
                            document.body.removeChild(button_entitymulti)

                            //controls.lookSpeed = 0
                            //place_camera(camera_placings[camera_placings.length-1])
                            // console.log(controls.object.rotation) // todo rm me
                            // if (controls.object.rotation.x!=starting_pos[0]||controls.object.rotation.y!=starting_pos[1]||controls.object.rotation.z!=starting_pos[2])
                            //controls.lookAt(model_spirit.position.x, model_spirit.position.y, model_spirit.position.z)

                            if (entity_type!='the obscure ones') {

                                var xhr = new XMLHttpRequest();
                                xhr.open("GET", 'https://lisica.lisica.ai:64244/aeriform', true)
                                xhr.setRequestHeader("username", username)
                                xhr.setRequestHeader("password", password)
                                xhr.setRequestHeader("cmd", "init")
                                xhr.setRequestHeader("template", entity_type)
                                xhr.onreadystatechange = function() {
                                    if (xhr.readyState == XMLHttpRequest.DONE) {
                                        var result = JSON.parse(xhr.responseText)
                                        console.log(result)
                                        document.body.style.cursor = 'auto'
                                    }
                                }
                                xhr.send()

                            }

                            var response = document.createElement('div')
                            response.style.position = 'absolute'
                            response.style.top = '6.666%'
                            response.style.left = '50%'
                            response.style.width = '366px'
                            response.style.textAlign = 'center'
                            document.body.appendChild(response)
                            response.style.color = 'white'
                            response.style.fontFamily = 'Courier New'
                            response.style.fontSize = '16px'
                                
                            var reply = document.createElement('input')
                            reply.style.position = 'absolute'
                            reply.style.bottom = '6.666%'
                            reply.style.right = '39.6%'
                            reply.style.height = '26px'
                            reply.style.width = '336px'
                            reply.style.textAlign = 'center'
                            reply.style.color = 'white'
                            reply.style.borderRadius = '16px'
                            reply.style.backgroundColor = 'rgba(0,0,0,.666)'
                            reply.style.outline = 'none'
                            reply.style.border = 'none'
                            reply.placeholder = ' leave empty to keep generating ..'
                            //document.body.appendChild(reply)
                            if (username==null) reply.readOnly = true

                            var send = document.createElement('button')
                            send.style.position = 'absolute'
                            send.style.bottom = '6.666%'
                            send.style.right = '21.6%'
                            //send.style.textAlign = 'center'
                            //send.style.color = 'white'
                            //send.style.padding = '6px'
                            send.style.borderRadius = '16px'
                            //send.innerHTML = 'Generate'
                            send.style.backgroundColor = 'rgba(0,0,0,.0)'
                            send.style.backgroundImage = 'url(generate.png)'
                            send.style.backgroundSize = 'contain'
                            send.style.backgroundPosition = 'center'
                            send.style.backgroundRepeat = 'no-repeat'
                            send.style.width = '33.6px'
                            send.style.height = '33.6px'
                            send.style.border = 'none'
                            send.style.cursor = 'pointer'
                            document.body.appendChild(send)

                            var reset = document.createElement('button')
                            reset.style.position = 'absolute'
                            reset.style.bottom = '6.666%'
                            reset.style.right = '16.6%'
                            reset.style.width = '33.6px'
                            reset.style.height = '33.6px'
                            reset.style.border = 'none'
                            reset.style.cursor = 'pointer'
                            reset.style.backgroundColor = 'rgba(0,0,0,.0)'
                            reset.style.backgroundImage = 'url(reset.png)'
                            reset.style.backgroundSize = 'contain'
                            reset.style.backgroundPosition = 'center'
                            reset.style.backgroundRepeat = 'no-repeat'
                            document.body.appendChild(reset)

                            var ar = document.createElement('button')
                            ar.style.position = 'absolute'
                            ar.style.bottom = '6.666%'
                            ar.style.right = '6.666%'
                            ar.style.width = '33.6px'
                            ar.style.height = '33.6px'
                            ar.style.border = 'none'
                            ar.style.cursor = 'pointer'
                            ar.style.backgroundColor = 'rgba(0,0,0,.0)'
                            ar.style.backgroundImage = 'url(ar.png)'
                            ar.style.backgroundSize = 'contain'
                            ar.style.backgroundPosition = 'center'
                            ar.style.backgroundRepeat = 'no-repeat'
                            //document.body.appendChild(ar)

                            send.onclick = () => {

                                if (response.innerHTML=='. . .') return

                                document.body.style.cursor = 'wait'

                                if (username!=null) {

                                    response.innerHTML = '. . .'
                                    xhr = new XMLHttpRequest();
                                    xhr.open("GET", 'https://lisica.lisica.ai:64244/aeriform', true)
                                    xhr.setRequestHeader("username", username)
                                    xhr.setRequestHeader("password", password)
                                    xhr.setRequestHeader("cmd", "generate")
                                    xhr.setRequestHeader("reply", reply.value)
                                    xhr.setRequestHeader("template", entity_type)
                                    xhr.onreadystatechange = function() {
                                        if (xhr.readyState == XMLHttpRequest.DONE) {
                                            var result = JSON.parse(xhr.responseText)
                                            response.innerHTML = result.response
                                            document.body.style.cursor = 'auto'
                                            reply.value = ''
                                            document.body.appendChild(reply)
                                            //document.body.appendChild(reset)
                                        }
                                    }
                                    xhr.send()

                                } else {

                                    document.body.style.cursor = 'auto'
                                    response.innerHTML = demos[entity_type][Math.floor(Math.random()*demos[entity_type].length)]
                                    reply.value = ''
                                    document.body.appendChild(reply)
                                    //document.body.appendChild(reset)
                                    
                                }
                                // reply.value = ''
                                // document.body.appendChild(reply)
                                // document.body.appendChild(reset)

                            }

                            reset.onclick = () => {

                                if (response.innerHTML=='. . .') return

                                stage_1_firsttime = false
                                stage = 1
                                response.innerHTML = ''

                                movement_enabled = false
                                //controls.lookSpeed = 0//.06
                                //place_camera(camera_placings[camera_placings.length-1])

                                var button_exists = false
                                for (let i = 0; i < document.body.children.length; i++)
                                    if (document.body.children[i] == send) {
                                        button_exists = true
                                        break
                                    }
                                //if (!button_exists) controls.lookAt(2.8984814900953606, -1.0141324546995314, -19.132418047956897)
                                if (!button_exists) place_camera(camera_placings[camera_placings.length-1])

                                scene.remove(model_spirit)

                                try { document.body.removeChild(reset) } catch { } 
                                try { document.body.removeChild(reply) } catch { } 
                                try { document.body.removeChild(send) } catch { }
                                try { document.body.removeChild(ar) } catch { } 

                                // ToDo: remoove 

                                model_spirits_floating.forEach((m)=>{ if (m!=null) scene.remove(m) })
                                //mixers_spirits_floating.forEach((m)=>{ if (m!=null) m.stopAllAction() })

                                textmeshes.forEach((m)=>scene.remove(m))
                                textmeshes = []

                                //console.log(renderer.info)

                            }

                            // var modelViewer

                            // ar.onclick = () => {

                            //     document.body.removeChild(ar)
                            
                            //     modelViewer = document.createElement('model-viewer')
                            //     modelViewer.setAttribute('ar', '')
                            //     modelViewer.setAttribute('src', 'spirit '+entity_type+'.glb')
                            //     modelViewer.setAttribute('ios-src', 'spirit '+entity_type+'.glb')
                            //     //modelViewer.setAttribute('auto-rotate', '')
                            //     modelViewer.setAttribute('camera-controls', '')
                            //     modelViewer.setAttribute('alt', 'A 3D model of an entity')
                            //     modelViewer.setAttribute('camera-orbit', '180deg 0deg 3m')
                            //     modelViewer.setAttribute('camera-target', '0m 1.66m 0m')
                            //     modelViewer.style.width = '100%'
                            //     modelViewer.style.height = '100%'

                            //     document.body.removeChild(renderer.domElement)
                            //     document.body.appendChild(modelViewer)
                            //     document.body.removeChild(send)
                            //     document.body.appendChild(send)
                            //     document.body.removeChild(reset)
                            //     document.body.appendChild(reset)
                            //     try {
                            //         document.body.removeChild(reply)
                            //         document.body.appendChild(reply)
                            //     } catch { }
                            //     try {
                            //         document.body.removeChild(response)
                            //         document.body.appendChild(response)
                            //     } catch { }

                            // }

                            if (entity_type!='the obscure ones') {

                                loader.load('spirit '+entity_type+'.glb', function ( gltf ) {
                                    model_spirit = gltf.scene
                                    model_spirit.rotateX(Math.PI/2)
                                    //scene.add(model_spirit)
                                    mixer = new THREE.AnimationMixer( model_spirit )
                                	mixer.clipAction( gltf.animations[ 2 ] ).play()
                                    model_spirit.name = "model_spirit"
                                    scene.add(model_spirit)
                                    model_spirit.position.x = camera_placings[camera_placings.length-1][0] + .936
                                    model_spirit.position.y = camera_placings[camera_placings.length-1][1] - .666
                                    model_spirit.position.z = camera_placings[camera_placings.length-1][2] - 3.666
                                    model_spirit.rotateZ(Math.PI/20)

                                    console.log("camera position:" + JSON.stringify(camera.position))
                                    console.log("camera rotation:" + JSON.stringify(camera.rotation))

                                    console.log("model position:" + JSON.stringify(model_spirit.position))
                                    console.log("model rotation:" + JSON.stringify(model_spirit.rotation))

                                    //document.body.appendChild(ar)
                                })

                            }

                            else {

                                movement_enabled = true
                                //controls.lookSpeed = .06
                                //controls.movementSpeed = .6

                                document.body.appendChild(reset)
                                document.body.removeChild(send)

                                if (model_stairs == null) {

                                    loader.load('stairs.glb', function ( gltf ) {
                                        model_stairs = gltf.scene
                                        model_stairs.rotateY(Math.PI/5)
                                        model_stairs.position.y = -6
                                        model_stairs.position.z = 18
                                        model_stairs.position.x = -1.4
                                        scene.add(model_stairs)
                                    })

                                }

                                // if (model_spring == null) {

                                //     loader.load('spring.glb', function ( gltf ) {
                                //         model_spring = gltf.scene
                                //         model_spring.scale.set(0.01, 0.01, 0.01)
                                //         // model_spring.rotateY(Math.PI/5)
                                //         // model_spring.position.y = -6
                                //         // model_spring.position.z = 18
                                //         model_spring.position.x = 6//4
                                //         scene.add(model_spring)
                                //     })

                                // }

                                const hm_floating_models = model_spirits_floating.length

                                var floating_loaded = true
                                for (const m of model_spirits_floating) if (m==null) { floating_loaded = false ; break}

                                if (!floating_loaded) {

                                    for (let i = 1; i < hm_floating_models+1; i++) {

                                        (new THREE.GLTFLoader()).load(('float'+i.toString()+'.glb').replace('%20',''), function ( gltf ) {
                                
                                            model_spirits_floating[i-1] = gltf.scene
                                            let model = model_spirits_floating[i-1]
                                            
                                            //scene.add(model)
                                            model.position.x = camera_placings[camera_placings.length-1][0] + .936
                                            model.position.y = camera_placings[camera_placings.length-1][1] - .666
                                            model.position.z = camera_placings[camera_placings.length-1][2] - 3.666
                                            model.rotateZ(Math.PI/20)
                                            model.rotateX(Math.PI/2)
                                            mixers_spirits_floating[i-1] = new THREE.AnimationMixer( model )
                                            mixers_spirits_floating[i-1].clipAction( gltf.animations[ 2 ] ).play()
                                        })

                                    }

                                    while (!floating_loaded) {
                                        floating_loaded = true
                                        for (const m of model_spirits_floating) if (m==null) { floating_loaded = false ; break}
                                        await sleep(.1)
                                    }

                                }

                                const entity_centers = [

                                    [1.8984814900953606, -1.0141324546995314, -17.0324180479569, 
                                     1.5707963267948963, 0, 0.15707963267948966],

                                    [1.8984814900953606, -1.0141324546995314, -14.0324180479569, 
                                    1.5707963267948963, 0, 0.15707963267948966],
                                    
                                    [1.8984814900953606, -1.0141324546995314, -10.0324180479569, 
                                    1.5707963267948963, 0, 0.15707963267948966],

                                    [1.8984814900953606, -1.0141324546995314, -8.0324180479569, 
                                    1.5707963267948963, 0, 0.15707963267948966],

                                    [1.8984814900953606, -1.0141324546995314, -4.0324180479569, 
                                    1.5707963267948963, 0, 0.15707963267948966],


                                    [1.8984814900953606, -1.0141324546995314, -1.0324180479569, 
                                    1.5707963267948963, 0, 0.15707963267948966],

                                ]

                                var seeds

                                let xhr_ = new XMLHttpRequest();
                                xhr_.open("GET", 'https://lisica.lisica.ai:64244/aeriform2', true)
                                xhr_.setRequestHeader("username", username)
                                xhr_.setRequestHeader("password", password)
                                xhr_.setRequestHeader("cmd", "init")
                                xhr_.setRequestHeader("template", entity_type)
                                xhr_.setRequestHeader("init_how_many", 5)
                                xhr_.onreadystatechange = function() {
                                    if (xhr_.readyState == XMLHttpRequest.DONE) {
                                        let result = JSON.parse(xhr_.responseText)
                                        seeds = result.answer.split('<>')
                                        console.log('seeds:'+seeds)
                                    }
                                }
                                xhr_.send()

                                document.body.style.cursor = 'wait'
                                var xhrs_completed = username==null
                                while(!xhrs_completed) {
                                    xhrs_completed = seeds!=null
                                    await sleep(.1)
                                }
                                document.body.style.cursor = 'auto'

                                var textmeshes = []

                                for (let i = 0; i < 5; i++) {

                                    if (Math.random() < .999) {

                                        model_spirits_floating[i].position.x = entity_centers[i][0]
                                        model_spirits_floating[i].position.y = entity_centers[i][1]
                                        model_spirits_floating[i].position.z = entity_centers[i][2]
                                        model_spirits_floating[i].rotation.x = entity_centers[i][3]
                                        model_spirits_floating[i].rotation.y = entity_centers[i][4]
                                        model_spirits_floating[i].rotation.z = entity_centers[i][5]

                                        scene.add(model_spirits_floating[i])

                                        textmeshes.push(
                                            write_smt(
                                                seeds[i],
                                                entity_centers[i][0], 
                                                entity_centers[i][1], 
                                                entity_centers[i][2], 
                                                entity_centers[i][3]+Math.PI,
                                                entity_centers[i][4],
                                                entity_centers[i][5]
                                            )
                                        )
                                        
                                    }

                                }
                                
                                

                                
                                    






                                async function check_generate() {

                                    while (true) {

                                        let i = 0
                                        for (const center of entity_centers) {
                                            i+=0

                                            if (Math.sqrt(
                                                Math.pow(camera.position.x-center[0],2)+
                                                Math.pow(camera.position.y-center[1],2)+
                                                Math.pow(camera.position.z-center[0],3)
                                            ) < 4) {

                                                console.log("generating for population " + i)

                                                let xhr_ = new XMLHttpRequest();
                                                xhr_.open("GET", 'https://lisica.lisica.ai:64244/aeriform2', true)
                                                xhr_.setRequestHeader("username", username)
                                                xhr_.setRequestHeader("password", password)
                                                xhr_.setRequestHeader("cmd", "generate")
                                                xhr_.setRequestHeader("template", entity_type)
                                                xhr_.setRequestHeader("population_id", i)
                                                xhr_.onreadystatechange = function() {
                                                    if (xhr_.readyState == XMLHttpRequest.DONE) {
                                                        let result = JSON.parse(xhr_.responseText)
                                                        console.log("population" + i + "response:" + JSON.stringify(result))
                                                        results[i] = result.answer
                                                    }
                                                }
                                                xhr_.send()

                                            } else {

                                                console.log(JSON.stringify(camera.position))

                                                console.log(JSON.stringify(center))

                                                // console.log(camera.position.x-center[0])
                                                // console.log(camera.position.y-center[1])
                                                // console.log(camera.position.z-center[2])
                    

                                                console.log('******')

                                            }

                                            await sleep(3)

                                            break

                                        }

                                        await sleep(.1)

                                    }

                                } check_generate()

                            }

                            while (stage==2) await sleep(.1)

                            break

                    }

            } main()

        </script>

	</body>

</html>
